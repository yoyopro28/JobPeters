<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Benzinpreis Abfrage</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .info { margin-top: 20px; font-size: 18px; }
  </style>
</head>
<body>
  <h1>Aktueller Benzinpreis</h1>
  <div class="info">
    <p>Preis: <span id="price">Lade...</span> €/l</p>
    <p>Abfragezeitpunkt: <span id="time">Lade...</span></p>
    <p>Letzte Preisanpassung: <span id="lastChange">Lade...</span></p>
  </div>

  <script>
    // ⚠️ API-Key niemals im Frontend ausliefern – über den Worker absichern/rotieren.
    const STATION_ID = 'e4df0a73-1c38-415c-8e46-03b0148fe1f2';
    const WORKER_URL = 'https://tankerkoenig-worker.alex-204.workers.dev';

    function fmtNumber(n) {
      if (typeof n !== 'number') return '';
      return n.toLocaleString('de-DE', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
    }

    function fmtDate(d) {
      try {
        const dt = new Date(d);
        if (isNaN(dt.getTime())) return '–';
        return dt.toLocaleString('de-DE');
      } catch {
        return '–';
      }
    }

    async function fetchFuelPrice() {
      try {
        // Falls dein Worker eine station_id erwartet, hänge sie an:
        const url = `${WORKER_URL}?station_id=${encodeURIComponent(STATION_ID)}`;
        const response = await fetch(url, { cache: 'no-store' });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();

        if (!data || data.ok === false) {
          document.getElementById('price').textContent = 'Fehler bei der Abfrage';
          document.getElementById('time').textContent = '–';
          document.getElementById('lastChange').textContent = '–';
          return;
        }

        // Mögliche Datenstrukturen abdecken:
        // Variante A (klassische /prices Antwort):
        // { ok: true, prices: { [id]: { e5, e10, diesel, status } }, timestamp?: string }
        // Variante B (eigener Worker): { price: ..., lastChange: ..., timestamp: ... }
        let priceValue;
        let lastChangeRaw;

        if (data.prices && data.prices[STATION_ID]) {
          const priceData = data.prices[STATION_ID];
          // Wähle hier den gewünschten Kraftstoff:
          priceValue = priceData.e10 ?? priceData.e5 ?? priceData.diesel;
          // Achtung: /prices liefert i.d.R. KEIN lastChange
          lastChangeRaw = priceData.lastChange || data.timestamp || null;
        } else if ('price' in data) {
          // Falls dein Worker bereits einen einzelnen Preis ausliefert
          priceValue = data.price;
          lastChangeRaw = data.lastChange || data.timestamp || null;
        }

        document.getElementById('price').textContent = fmtNumber(Number(priceValue));
        document.getElementById('time').textContent = fmtDate(new Date());
        document.getElementById('lastChange').textContent = lastChangeRaw ? fmtDate(lastChangeRaw) : '–';
      } catch (err) {
        document.getElementById('price').textContent = 'Fehler: ' + err.message;
        document.getElementById('time').textContent = '–';
        document.getElementById('lastChange').textContent = '–';
      }
    }

    fetchFuelPrice();
  </script>
</body>
</html>
